<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Document Upload</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        #progress {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        #progressBar {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Document Upload Test Tool</h1>
    
    <div class="section">
        <h2>1. Check Backend Health</h2>
        <button onclick="checkHealth()">Check Health</button>
        <div id="healthResult"></div>
    </div>

    <div class="section">
        <h2>2. Check Authentication</h2>
        <p>Current Token: <span id="tokenStatus"></span></p>
        <button onclick="checkAuth()">Check Auth</button>
        <div id="authResult"></div>
    </div>

    <div class="section">
        <h2>3. Upload Document</h2>
        <input type="file" id="fileInput" accept=".pdf,.txt,.md">
        <br>
        <button onclick="uploadDocument()">Upload & Process</button>
        <div id="progress">
            <div id="progressBar">0%</div>
        </div>
        <div id="uploadResult"></div>
    </div>

    <div class="section">
        <h2>4. List Documents</h2>
        <button onclick="listDocuments()">List My Documents</button>
        <div id="documentsResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        function getToken() {
            return localStorage.getItem('auth_token');
        }

        function updateTokenStatus() {
            const token = getToken();
            document.getElementById('tokenStatus').textContent = token ? 
                `${token.substring(0, 20)}...` : 'Not logged in';
        }

        async function checkHealth() {
            const result = document.getElementById('healthResult');
            result.innerHTML = '<p class="info">Checking...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/scaledown/health`);
                const data = await response.json();
                
                result.innerHTML = `
                    <p class="${data.status === 'healthy' ? 'success' : 'error'}">
                        Status: ${data.status}
                    </p>
                    <p>Gemini Available: ${data.gemini_available ? '✅ Yes' : '❌ No'}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function checkAuth() {
            const result = document.getElementById('authResult');
            const token = getToken();
            
            if (!token) {
                result.innerHTML = '<p class="error">No auth token found. Please log in first.</p>';
                return;
            }

            result.innerHTML = '<p class="info">Checking...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `
                        <p class="success">✅ Authenticated</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    const error = await response.json();
                    result.innerHTML = `
                        <p class="error">❌ Authentication failed</p>
                        <p>Status: ${response.status}</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const result = document.getElementById('uploadResult');
            const progressBar = document.getElementById('progressBar');
            const token = getToken();
            
            if (!token) {
                result.innerHTML = '<p class="error">Please log in first</p>';
                return;
            }

            if (!fileInput.files[0]) {
                result.innerHTML = '<p class="error">Please select a file</p>';
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            result.innerHTML = '<p class="info">Uploading...</p>';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 50);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
            });

            xhr.addEventListener('load', () => {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                if (xhr.status >= 200 && xhr.status < 300) {
                    const data = JSON.parse(xhr.responseText);
                    result.innerHTML = `
                        <p class="success">✅ Upload successful!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    try {
                        const error = JSON.parse(xhr.responseText);
                        result.innerHTML = `
                            <p class="error">❌ Upload failed</p>
                            <p>Status: ${xhr.status}</p>
                            <pre>${JSON.stringify(error, null, 2)}</pre>
                        `;
                    } catch {
                        result.innerHTML = `
                            <p class="error">❌ Upload failed</p>
                            <p>Status: ${xhr.status}</p>
                            <p>${xhr.responseText}</p>
                        `;
                    }
                }
            });

            xhr.addEventListener('error', () => {
                result.innerHTML = '<p class="error">❌ Network error</p>';
            });

            xhr.open('POST', `${API_BASE}/scaledown/upload-and-process`);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            xhr.send(formData);
        }

        async function listDocuments() {
            const result = document.getElementById('documentsResult');
            const token = getToken();
            
            if (!token) {
                result.innerHTML = '<p class="error">Please log in first</p>';
                return;
            }

            result.innerHTML = '<p class="info">Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/scaledown/documents`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `
                        <p class="success">✅ Found ${data.length} document(s)</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    const error = await response.json();
                    result.innerHTML = `
                        <p class="error">❌ Failed to load documents</p>
                        <p>Status: ${response.status}</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        // Initialize
        updateTokenStatus();
        setInterval(updateTokenStatus, 1000);
    </script>
</body>
</html>
